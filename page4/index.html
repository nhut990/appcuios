<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caro Online 2 Ng∆∞·ªùi</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 600px;
            width: 100%;
        }
        
        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 20px;
            font-size: 2em;
        }
        
        .setup-screen, .game-screen {
            display: none;
        }
        
        .setup-screen.active, .game-screen.active {
            display: block;
        }
        
        .input-group {
            margin: 20px 0;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }
        
        input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
            margin-top: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .info-box {
            background: #f0f4ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #667eea;
        }
        
        .info-box p {
            margin: 5px 0;
            color: #555;
        }
        
        .game-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .player-info {
            flex: 1;
            min-width: 150px;
            padding: 10px;
            background: #f0f4ff;
            border-radius: 8px;
            text-align: center;
        }
        
        .player-info.active {
            background: #667eea;
            color: white;
        }
        
        .board {
            display: grid;
            grid-template-columns: repeat(15, 1fr);
            gap: 2px;
            background: #ccc;
            padding: 2px;
            border-radius: 8px;
            margin: 20px 0;
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .cell {
            aspect-ratio: 1;
            background: white;
            border: none;
            cursor: pointer;
            font-size: 20px;
            font-weight: bold;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .cell:hover:not(:disabled) {
            background: #f0f4ff;
        }
        
        .cell:disabled {
            cursor: not-allowed;
        }
        
        .cell.x {
            color: #e74c3c;
        }
        
        .cell.o {
            color: #3498db;
        }
        
        .status {
            text-align: center;
            font-size: 18px;
            margin: 15px 0;
            font-weight: 600;
            color: #333;
        }
        
        .btn-secondary {
            background: #95a5a6;
            margin-top: 15px;
        }
        
        .loading {
            text-align: center;
            color: #667eea;
            font-style: italic;
        }

        @media (max-width: 600px) {
            .board {
                gap: 1px;
            }
            .cell {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéÆ Caro Online</h1>
        
        <div class="setup-screen active" id="setupScreen">
            <div class="info-box">
                <p><strong>üìå H∆∞·ªõng d·∫´n:</strong></p>
                <p>1. Ng∆∞·ªùi ch∆°i 1 t·∫°o ph√≤ng m·ªõi v√† chia s·∫ª M√£ ph√≤ng</p>
                <p>2. Ng∆∞·ªùi ch∆°i 2 nh·∫≠p M√£ ph√≤ng ƒë·ªÉ tham gia</p>
                <p>3. Ng∆∞·ªùi t·∫°o ph√≤ng ƒëi tr∆∞·ªõc (X), ng∆∞·ªùi tham gia ƒëi sau (O)</p>
            </div>
            
            <div class="input-group">
                <label>T√™n c·ªßa b·∫°n:</label>
                <input type="text" id="playerName" placeholder="Nh·∫≠p t√™n..." maxlength="20">
            </div>
            
            <button class="btn" onclick="createRoom()">T·∫°o Ph√≤ng M·ªõi</button>
            
            <div class="input-group" style="margin-top: 30px;">
                <label>Ho·∫∑c nh·∫≠p M√£ ph√≤ng ƒë·ªÉ tham gia:</label>
                <input type="text" id="roomCode" placeholder="Nh·∫≠p m√£ ph√≤ng..." maxlength="20">
            </div>
            
            <button class="btn" onclick="joinRoom()">Tham Gia Ph√≤ng</button>
        </div>
        
        <div class="game-screen" id="gameScreen">
            <div class="info-box" id="roomInfo"></div>
            
            <div class="game-info">
                <div class="player-info" id="player1Info">
                    <div>Ng∆∞·ªùi ch∆°i 1 (X)</div>
                    <div id="player1Name">---</div>
                </div>
                <div class="player-info" id="player2Info">
                    <div>Ng∆∞·ªùi ch∆°i 2 (O)</div>
                    <div id="player2Name">ƒêang ch·ªù...</div>
                </div>
            </div>
            
            <div class="status" id="status">ƒêang ch·ªù ng∆∞·ªùi ch∆°i th·ª© 2...</div>
            
            <div class="board" id="board"></div>
            
            <button class="btn btn-secondary" onclick="leaveRoom()">R·ªùi Ph√≤ng</button>
        </div>
    </div>

    <script>
        let gameState = {
            roomCode: '',
            playerName: '',
            playerNumber: 0,
            currentTurn: 1,
            board: Array(15).fill(null).map(() => Array(15).fill(null)),
            gameActive: false,
            player1Name: '',
            player2Name: ''
        };
        
        let pollInterval;
        
        function generateRoomCode() {
            return 'CARO-' + Math.random().toString(36).substring(2, 8).toUpperCase();
        }
        
        async function createRoom() {
            const name = document.getElementById('playerName').value.trim();
            if (!name) {
                alert('Vui l√≤ng nh·∫≠p t√™n c·ªßa b·∫°n!');
                return;
            }
            
            const roomCode = generateRoomCode();
            gameState.roomCode = roomCode;
            gameState.playerName = name;
            gameState.playerNumber = 1;
            gameState.player1Name = name;
            
            try {
                await window.storage.set(`room:${roomCode}`, JSON.stringify({
                    player1: name,
                    player2: null,
                    currentTurn: 1,
                    board: gameState.board,
                    gameActive: false,
                    winner: null
                }), true);
                
                showGameScreen();
                startPolling();
            } catch (error) {
                alert('L·ªói t·∫°o ph√≤ng: ' + error.message);
            }
        }
        
        async function joinRoom() {
            const name = document.getElementById('playerName').value.trim();
            const roomCode = document.getElementById('roomCode').value.trim();
            
            if (!name || !roomCode) {
                alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!');
                return;
            }
            
            try {
                const result = await window.storage.get(`room:${roomCode}`, true);
                if (!result) {
                    alert('Kh√¥ng t√¨m th·∫•y ph√≤ng v·ªõi m√£ n√†y!');
                    return;
                }
                
                const roomData = JSON.parse(result.value);
                
                if (roomData.player2) {
                    alert('Ph√≤ng n√†y ƒë√£ ƒë·ªß ng∆∞·ªùi ch∆°i!');
                    return;
                }
                
                gameState.roomCode = roomCode;
                gameState.playerName = name;
                gameState.playerNumber = 2;
                gameState.player1Name = roomData.player1;
                gameState.player2Name = name;
                
                roomData.player2 = name;
                roomData.gameActive = true;
                
                await window.storage.set(`room:${roomCode}`, JSON.stringify(roomData), true);
                
                showGameScreen();
                startPolling();
            } catch (error) {
                alert('L·ªói tham gia ph√≤ng: ' + error.message);
            }
        }
        
        function showGameScreen() {
            document.getElementById('setupScreen').classList.remove('active');
            document.getElementById('gameScreen').classList.add('active');
            
            document.getElementById('roomInfo').innerHTML = `
                <p><strong>M√£ ph√≤ng:</strong> ${gameState.roomCode}</p>
                <p><small>Chia s·∫ª m√£ n√†y cho ng∆∞·ªùi ch∆°i th·ª© 2</small></p>
            `;
            
            document.getElementById('player1Name').textContent = gameState.player1Name;
            
            createBoard();
            updateUI();
        }
        
        function createBoard() {
            const board = document.getElementById('board');
            board.innerHTML = '';
            
            for (let i = 0; i < 15; i++) {
                for (let j = 0; j < 15; j++) {
                    const cell = document.createElement('button');
                    cell.className = 'cell';
                    cell.dataset.row = i;
                    cell.dataset.col = j;
                    cell.onclick = () => makeMove(i, j);
                    board.appendChild(cell);
                }
            }
        }
        
        async function makeMove(row, col) {
            if (!gameState.gameActive || gameState.currentTurn !== gameState.playerNumber) {
                return;
            }
            
            if (gameState.board[row][col] !== null) {
                return;
            }
            
            try {
                const result = await window.storage.get(`room:${gameState.roomCode}`, true);
                const roomData = JSON.parse(result.value);
                
                if (roomData.board[row][col] !== null || roomData.currentTurn !== gameState.playerNumber) {
                    await updateFromServer(roomData);
                    return;
                }
                
                const symbol = gameState.playerNumber === 1 ? 'X' : 'O';
                roomData.board[row][col] = symbol;
                
                const winner = checkWinner(roomData.board, row, col, symbol);
                
                if (winner) {
                    roomData.winner = gameState.playerNumber;
                    roomData.gameActive = false;
                } else if (isBoardFull(roomData.board)) {
                    roomData.winner = 0;
                    roomData.gameActive = false;
                } else {
                    roomData.currentTurn = gameState.playerNumber === 1 ? 2 : 1;
                }
                
                await window.storage.set(`room:${gameState.roomCode}`, JSON.stringify(roomData), true);
                await updateFromServer(roomData);
            } catch (error) {
                console.error('L·ªói th·ª±c hi·ªán n∆∞·ªõc ƒëi:', error);
            }
        }
        
        function checkWinner(board, row, col, symbol) {
            const directions = [
                [[0, 1], [0, -1]],
                [[1, 0], [-1, 0]],
                [[1, 1], [-1, -1]],
                [[1, -1], [-1, 1]]
            ];
            
            for (let [dir1, dir2] of directions) {
                let count = 1;
                
                for (let [dx, dy] of [dir1, dir2]) {
                    let r = row + dx;
                    let c = col + dy;
                    while (r >= 0 && r < 15 && c >= 0 && c < 15 && board[r][c] === symbol) {
                        count++;
                        r += dx;
                        c += dy;
                    }
                }
                
                if (count >= 5) return true;
            }
            
            return false;
        }
        
        function isBoardFull(board) {
            return board.every(row => row.every(cell => cell !== null));
        }
        
        async function pollServer() {
            try {
                const result = await window.storage.get(`room:${gameState.roomCode}`, true);
                if (result) {
                    const roomData = JSON.parse(result.value);
                    await updateFromServer(roomData);
                }
            } catch (error) {
                console.error('L·ªói c·∫≠p nh·∫≠t:', error);
            }
        }
        
        async function updateFromServer(roomData) {
            gameState.board = roomData.board;
            gameState.currentTurn = roomData.currentTurn;
            gameState.gameActive = roomData.gameActive;
            gameState.player1Name = roomData.player1;
            gameState.player2Name = roomData.player2 || 'ƒêang ch·ªù...';
            
            updateUI();
            
            if (roomData.winner !== undefined && roomData.winner !== null) {
                let message;
                if (roomData.winner === 0) {
                    message = 'H√≤a! B√†n c·ªù ƒë√£ ƒë·∫ßy.';
                } else if (roomData.winner === gameState.playerNumber) {
                    message = 'üéâ B·∫°n th·∫Øng!';
                } else {
                    message = 'üò¢ B·∫°n thua!';
                }
                
                setTimeout(() => {
                    if (confirm(message + '\n\nCh∆°i l·∫°i?')) {
                        resetGame();
                    }
                }, 100);
            }
        }
        
        function updateUI() {
            document.getElementById('player1Name').textContent = gameState.player1Name;
            document.getElementById('player2Name').textContent = gameState.player2Name;
            
            const player1Info = document.getElementById('player1Info');
            const player2Info = document.getElementById('player2Info');
            
            player1Info.classList.toggle('active', gameState.currentTurn === 1);
            player2Info.classList.toggle('active', gameState.currentTurn === 2);
            
            const cells = document.querySelectorAll('.cell');
            cells.forEach(cell => {
                const row = parseInt(cell.dataset.row);
                const col = parseInt(cell.dataset.col);
                const value = gameState.board[row][col];
                
                cell.textContent = value || '';
                cell.className = 'cell' + (value ? ` ${value.toLowerCase()}` : '');
                cell.disabled = !gameState.gameActive || value !== null || gameState.currentTurn !== gameState.playerNumber;
            });
            
            let statusText;
            if (!gameState.gameActive && !gameState.player2Name) {
                statusText = 'ƒêang ch·ªù ng∆∞·ªùi ch∆°i th·ª© 2...';
            } else if (gameState.gameActive) {
                if (gameState.currentTurn === gameState.playerNumber) {
                    statusText = '‚ú® ƒê·∫øn l∆∞·ª£t b·∫°n!';
                } else {
                    statusText = '‚è≥ ƒêang ch·ªù ƒë·ªëi th·ªß...';
                }
            } else {
                statusText = 'Tr√≤ ch∆°i k·∫øt th√∫c';
            }
            
            document.getElementById('status').textContent = statusText;
        }
        
        async function resetGame() {
            try {
                const result = await window.storage.get(`room:${gameState.roomCode}`, true);
                const roomData = JSON.parse(result.value);
                
                roomData.board = Array(15).fill(null).map(() => Array(15).fill(null));
                roomData.currentTurn = 1;
                roomData.gameActive = true;
                roomData.winner = null;
                
                await window.storage.set(`room:${gameState.roomCode}`, JSON.stringify(roomData), true);
                await updateFromServer(roomData);
            } catch (error) {
                alert('L·ªói kh·ªüi ƒë·ªông l·∫°i game: ' + error.message);
            }
        }
        
        function startPolling() {
            pollInterval = setInterval(pollServer, 1000);
        }
        
        function leaveRoom() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën r·ªùi ph√≤ng?')) {
                clearInterval(pollInterval);
                location.reload();
            }
        }
    </script>
</body>
</html>